{% extends 'votacion/base.html' %}

{% block title %}Mapa de Calor - Votantes{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'encuestador_estadisticas' %}" class="text-decoration-none">Estadísticas</a></li>
<li class="breadcrumb-item active">Mapa de Calor</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
#mapa-calor-container {
  height: calc(100vh - 260px);
  min-height: 480px;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 12px rgba(0,0,0,.08);
}
.filtros-card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.07); }
.leyenda {
  background: white;
  padding: 10px 14px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
  font-size: .82rem;
  line-height: 1.7;
}
.leyenda-gradiente {
  height: 12px;
  border-radius: 6px;
  background: linear-gradient(to right, #00f, #0ff, #0f0, #ff0, #f00);
  margin-bottom: 4px;
}
</style>
{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <h4 class="fw-bold mb-0">
    <i class="bi bi-map text-danger me-2"></i>Mapa de Calor — Votantes por Residencia
  </h4>
  <div class="d-flex gap-2">
    <a href="{% url 'encuestador_estadisticas' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-bar-chart-line me-1"></i>Estadísticas
    </a>
    <a href="{% url 'encuestador_inicio' %}" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-clipboard2-pulse me-1"></i>Encuestar
    </a>
  </div>
</div>

<!-- Filtros -->
<div class="card filtros-card mb-3">
  <div class="card-body p-3">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label fw-semibold mb-1 small text-muted">
          <i class="bi bi-calendar-event me-1"></i>Filtrar por evento
        </label>
        <select name="evento" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">— Todos los votantes con ubicación —</option>
          {% for ev in eventos %}
          <option value="{{ ev.pk }}" {% if evento_sel and evento_sel.pk == ev.pk %}selected{% endif %}>
            {{ ev.nombre }}
          </option>
          {% endfor %}
        </select>
      </div>

      {% if candidatos %}
      <div class="col-12 col-md-4">
        <label class="form-label fw-semibold mb-1 small text-muted">
          <i class="bi bi-person-badge me-1"></i>Filtrar por candidato
        </label>
        <select name="candidato" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">— Todos los candidatos —</option>
          {% for c in candidatos %}
          <option value="{{ c.pk }}" {% if candidato_sel and candidato_sel.pk == c.pk %}selected{% endif %}>
            {{ c.nombre_completo }}
          </option>
          {% endfor %}
        </select>
        {% if evento_sel %}<input type="hidden" name="evento" value="{{ evento_sel.pk }}">{% endif %}
      </div>
      {% endif %}

      <div class="col-12 col-md-auto">
        <a href="{% url 'mapa_calor_votantes' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-x-circle me-1"></i>Limpiar filtros
        </a>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="col-12 col-md-auto ms-md-auto text-end">
        <div class="d-flex gap-3 justify-content-end flex-wrap">
          <div class="text-center">
            <div class="fw-bold text-primary fs-5 lh-1">{{ total_puntos }}</div>
            <div class="text-muted" style="font-size:.72rem;">
              {% if evento_sel or candidato_sel %}Puntos filtrados{% else %}Con ubicación{% endif %}
            </div>
          </div>
          <div class="text-center">
            <div class="fw-bold text-success fs-5 lh-1">{{ total_votantes_geo }}</div>
            <div class="text-muted" style="font-size:.72rem;">Total con GPS</div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Mapa -->
{% if total_puntos > 0 %}
<div id="mapa-calor-container">
  <div id="mapa-calor" style="height:100%;width:100%;"></div>
</div>
<p class="text-muted mt-2 small">
  <i class="bi bi-info-circle me-1"></i>
  Las zonas rojas indican mayor concentración de votantes. Haz clic en un marcador para ver los datos del ciudadano.
  <span class="ms-2">
    <a href="#" id="toggle-modo" class="text-decoration-none">Cambiar a vista de marcadores</a>
  </span>
</p>

{% else %}
<div class="card filtros-card text-center py-5">
  <i class="bi bi-geo text-muted fs-2 d-block mb-3"></i>
  <h6 class="text-muted">
    {% if evento_sel or candidato_sel %}
      No hay votantes con ubicación registrada para este filtro.
    {% else %}
      Aún no hay votantes con ubicación geográfica registrada.
    {% endif %}
  </h6>
  <p class="text-muted small">La ubicación se registra al crear o editar un votante en el formulario.</p>
  <a href="{% url 'votante_lista' %}" class="btn btn-outline-primary mt-2">
    <i class="bi bi-people me-1"></i>Ir a Votantes
  </a>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if total_puntos > 0 %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<!-- Leaflet.heat para el mapa de calor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<script>
const PUNTOS = {{ puntos_json|safe }};

// Calcular centro del mapa según los puntos
function calcularCentro(pts) {
  if (!pts.length) return [4.711, -74.0721];
  const lat = pts.reduce((s, p) => s + p.lat, 0) / pts.length;
  const lng = pts.reduce((s, p) => s + p.lng, 0) / pts.length;
  return [lat, lng];
}

const centro = calcularCentro(PUNTOS);
const mapa = L.map('mapa-calor').setView(centro, PUNTOS.length === 1 ? 14 : 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19
}).addTo(mapa);

// ── Capa de calor ─────────────────────────────────────────────────
const heatData = PUNTOS.map(p => [p.lat, p.lng, 1]);
const calorCapa = L.heatLayer(heatData, {
  radius: 30,
  blur: 20,
  maxZoom: 17,
  gradient: { 0.2: '#3388ff', 0.4: '#00ffff', 0.6: '#00ff00', 0.8: '#ffff00', 1.0: '#ff0000' }
}).addTo(mapa);

// ── Capa de marcadores (oculta por defecto) ───────────────────────
const icono = L.divIcon({
  html: '<div style="background:#dc3545;width:16px;height:16px;border-radius:50%;border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,.4);"></div>',
  iconSize: [16,16], iconAnchor: [8,8]
});

const marcadoresCapa = L.layerGroup();
PUNTOS.forEach(p => {
  const popup = `<div style="min-width:180px">
    <b>${p.nombre}</b><br>
    <span class="text-muted">CC: ${p.cedula}</span><br>
    ${p.dir ? '<i class="bi bi-house"></i> ' + p.dir + '<br>' : ''}
    ${p.mun ? '<i class="bi bi-geo-alt"></i> ' + p.mun : ''}
  </div>`;
  L.marker([p.lat, p.lng], { icon: icono }).bindPopup(popup).addTo(marcadoresCapa);
});

// ── Leyenda ───────────────────────────────────────────────────────
const leyenda = L.control({ position: 'bottomright' });
leyenda.onAdd = () => {
  const div = L.DomUtil.create('div', 'leyenda');
  div.innerHTML = `
    <div style="font-weight:700;margin-bottom:4px;">Densidad</div>
    <div class="leyenda-gradiente"></div>
    <div style="display:flex;justify-content:space-between">
      <span>Baja</span><span>Alta</span>
    </div>
    <div style="margin-top:6px;color:#666;">${PUNTOS.length} votante${PUNTOS.length !== 1 ? 's' : ''}</div>
  `;
  return div;
};
leyenda.addTo(mapa);

// ── Toggle entre modos calor / marcadores ─────────────────────────
let modoCalor = true;
document.getElementById('toggle-modo').addEventListener('click', e => {
  e.preventDefault();
  if (modoCalor) {
    mapa.removeLayer(calorCapa);
    marcadoresCapa.addTo(mapa);
    e.target.textContent = 'Cambiar a mapa de calor';
  } else {
    mapa.removeLayer(marcadoresCapa);
    calorCapa.addTo(mapa);
    e.target.textContent = 'Cambiar a vista de marcadores';
  }
  modoCalor = !modoCalor;
});

// Fit bounds si hay múltiples puntos
if (PUNTOS.length > 1) {
  const bounds = PUNTOS.map(p => [p.lat, p.lng]);
  mapa.fitBounds(bounds, { padding: [40, 40] });
}

setTimeout(() => mapa.invalidateSize(), 300);
</script>
{% endif %}
{% endblock %}
