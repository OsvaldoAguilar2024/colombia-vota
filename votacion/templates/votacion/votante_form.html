{% extends 'votacion/base.html' %}

{% block title %}{{ titulo }} - Colombia Vota{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'votante_lista' %}" class="text-decoration-none">Votantes</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">

        <h4 class="fw-bold mb-4">
          <i class="bi bi-person-plus text-primary me-2"></i>{{ titulo }}
        </h4>

        {% if from_encuestador %}
        <div class="alert alert-info d-flex align-items-center gap-2 mb-4">
          <i class="bi bi-info-circle-fill"></i>
          <span>El ciudadano no estÃ¡ registrado. Complete sus datos para continuar con la encuesta.</span>
        </div>
        {% endif %}

        {% if form.errors %}
        <div class="alert alert-danger mb-4">
          <strong><i class="bi bi-exclamation-triangle me-2"></i>Corrige los siguientes errores:</strong>
          <ul class="mb-0 mt-2">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}<li><strong>{{ field }}:</strong> {{ error }}</li>{% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <form method="post" id="votanteForm">
          {% csrf_token %}
          {% if from_encuestador %}<input type="hidden" name="from_encuestador" value="1">{% endif %}

          {{form.latitud}}
          {{form.longitud}}

          <!-- â•â•â• DATOS PERSONALES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <h5 class="text-primary mb-3"><i class="bi bi-person-badge me-2"></i>Datos Personales</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">NÃºmero de CÃ©dula <span class="text-danger">*</span></label>
              {{form.cedula}}
              {% if form.cedula.errors %}<div class="text-danger small">{{form.cedula.errors.0}}</div>{% endif %}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Nombres <span class="text-danger">*</span></label>
              {{form.nombres}}
              {% if form.nombres.errors %}<div class="text-danger small">{{form.nombres.errors.0}}</div>{% endif %}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Apellidos <span class="text-danger">*</span></label>
              {{form.apellidos}}
              {% if form.apellidos.errors %}<div class="text-danger small">{{form.apellidos.errors.0}}</div>{% endif %}
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Correo ElectrÃ³nico</label>
              {{form.email}}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">TelÃ©fono</label>
              {{form.telefono}}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Fecha de Nacimiento</label>
              {{form.fecha_nacimiento}}
            </div>
          </div>

          <hr>

          <!-- â•â•â• LUGAR DE VOTACIÃ“N â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <h5 class="text-primary mb-3"><i class="bi bi-geo-alt me-2"></i>Lugar de VotaciÃ³n</h5>

          <!-- Campos hidden: reciben valor de los selects JS y se envÃ­an al servidor -->
          <input type="hidden" name="departamento" id="hid_dep"    value="{{ form.instance.departamento_id|default:'' }}">
          <input type="hidden" name="municipio"    id="hid_mun"    value="{{ form.instance.municipio_id|default:'' }}">
          <input type="hidden" name="puesto"       id="hid_puesto" value="{{ form.instance.puesto_id|default:'' }}">
          <input type="hidden" name="mesa"         id="hid_mesa"   value="{{ form.instance.mesa_id|default:'' }}">

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Departamento</label>
              <select id="sel_dep" class="form-select">
                <option value="">â€” Selecciona departamento â€”</option>
                {% for dep in departamentos %}
                <option value="{{ dep.id }}" {% if form.instance.departamento_id == dep.id %}selected{% endif %}>
                  {{ dep.nombre }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ciudad / Municipio</label>
              <select id="sel_mun" class="form-select">
                <option value="">â€” Selecciona departamento primero â€”</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Puesto de VotaciÃ³n</label>
              <select id="sel_puesto" class="form-select">
                <option value="">â€” Selecciona municipio primero â€”</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Mesa</label>
              <select id="sel_mesa" class="form-select">
                <option value="">â€” Selecciona puesto primero â€”</option>
              </select>
            </div>
          </div>

          <hr>

          <!-- â•â•â• DIRECCIÃ“N DE RESIDENCIA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <h5 class="text-success mb-3"><i class="bi bi-pin-map me-2"></i>DirecciÃ³n de Residencia</h5>
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">DirecciÃ³n</label>
              {{form.direccion}}
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Barrio</label>
              {{form.barrio}}
            </div>
          </div>
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-map text-success me-1"></i>UbicaciÃ³n en el mapa
              <small class="text-muted fw-normal">(clic en el mapa o usa el GPS)</small>
            </label>
            <div class="d-flex gap-2 mb-2 flex-wrap">
              <button type="button" class="btn btn-outline-success btn-sm" onclick="usarGPS()">
                <i class="bi bi-crosshair2 me-1"></i>Detectar mi ubicaciÃ³n
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="buscarDir()">
                <i class="bi bi-search me-1"></i>Buscar direcciÃ³n en mapa
              </button>
              <span id="gps-status" class="text-muted small align-self-center"></span>
            </div>
            <div id="mapa-votante" style="height:320px;border-radius:12px;border:1px solid #dee2e6;"></div>
            <p class="text-muted mt-1 mb-0" style="font-size:.75rem;">
              <i class="bi bi-info-circle me-1"></i>Haz clic en el mapa para marcar la direcciÃ³n exacta del votante.
            </p>
          </div>

          <hr>

          <!-- â•â•â• BOTONES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-check-circle me-1"></i>Guardar Votante
            </button>
            <a href="{% url 'votante_lista' %}" class="btn btn-secondary btn-lg">Cancelar</a>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// â•â• CASCADA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const selDep    = document.getElementById('sel_dep');
const selMun    = document.getElementById('sel_mun');
const selPuesto = document.getElementById('sel_puesto');
const selMesa   = document.getElementById('sel_mesa');
const hidDep    = document.getElementById('hid_dep');
const hidMun    = document.getElementById('hid_mun');
const hidPuesto = document.getElementById('hid_puesto');
const hidMesa   = document.getElementById('hid_mesa');

// Valores a pre-seleccionar al editar
const SAVED = { dep: hidDep.value, mun: hidMun.value, puesto: hidPuesto.value, mesa: hidMesa.value };

function llenar(sel, items, placeholder, autoId) {
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  items.forEach(it => {
    const o = document.createElement('option');
    o.value = it.id; o.textContent = it.txt;
    if (String(it.id) === String(autoId)) o.selected = true;
    sel.appendChild(o);
  });
}

function cargarMuns(depId, autoMun) {
  llenar(selMun,    [], 'â€” Cargandoâ€¦ â€”', '');
  llenar(selPuesto, [], 'â€” Selecciona municipio primero â€”', '');
  llenar(selMesa,   [], 'â€” Selecciona puesto primero â€”', '');
  hidMun.value = ''; hidPuesto.value = ''; hidMesa.value = '';
  if (!depId) { llenar(selMun, [], 'â€” Selecciona departamento primero â€”', ''); return; }
  fetch('/api/municipios/?departamento_id=' + depId)
    .then(r => r.json()).then(data => {
      llenar(selMun, data.map(m => ({id: m.id, txt: m.nombre})), 'â€” Selecciona municipio â€”', autoMun);
      if (autoMun) { hidMun.value = autoMun; cargarPuestos(autoMun, SAVED.puesto); }
    });
}

function cargarPuestos(munId, autoPuesto) {
  llenar(selPuesto, [], 'â€” Cargandoâ€¦ â€”', '');
  llenar(selMesa,   [], 'â€” Selecciona puesto primero â€”', '');
  hidPuesto.value = ''; hidMesa.value = '';
  if (!munId) { llenar(selPuesto, [], 'â€” Selecciona municipio primero â€”', ''); return; }
  fetch('/api/puestos/?municipio_id=' + munId)
    .then(r => r.json()).then(data => {
      llenar(selPuesto, data.map(p => ({id: p.id, txt: p.nombre})), 'â€” Selecciona puesto â€”', autoPuesto);
      if (autoPuesto) { hidPuesto.value = autoPuesto; cargarMesas(autoPuesto, SAVED.mesa); }
    });
}

function cargarMesas(puestoId, autoMesa) {
  llenar(selMesa, [], 'â€” Cargandoâ€¦ â€”', '');
  hidMesa.value = '';
  if (!puestoId) { llenar(selMesa, [], 'â€” Selecciona puesto primero â€”', ''); return; }
  fetch('/api/mesas/?puesto_id=' + puestoId)
    .then(r => r.json()).then(data => {
      llenar(selMesa, data.map(m => ({id: m.id, txt: 'Mesa ' + m.numero + (m.zona ? ' â€” '+m.zona : '')})), 'â€” Selecciona mesa â€”', autoMesa);
      if (autoMesa) hidMesa.value = autoMesa;
    });
}

selDep.addEventListener('change', e => {
  hidDep.value = e.target.value;
  SAVED.mun = ''; SAVED.puesto = ''; SAVED.mesa = '';
  cargarMuns(e.target.value, '');
});
selMun.addEventListener('change', e => {
  hidMun.value = e.target.value;
  SAVED.puesto = ''; SAVED.mesa = '';
  cargarPuestos(e.target.value, '');
});
selPuesto.addEventListener('change', e => {
  hidPuesto.value = e.target.value;
  SAVED.mesa = '';
  cargarMesas(e.target.value, '');
});
selMesa.addEventListener('change', e => { hidMesa.value = e.target.value; });

// Pre-cargar al editar
if (SAVED.dep) cargarMuns(SAVED.dep, SAVED.mun);

// â•â• MAPA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const latInput = document.querySelector('[name="latitud"]');
const lngInput = document.querySelector('[name="longitud"]');
const LAT0 = parseFloat(latInput.value) || 4.711;
const LNG0 = parseFloat(lngInput.value) || -74.0721;
const ZOOM0 = latInput.value ? 15 : 6;

const mapa = L.map('mapa-votante').setView([LAT0, LNG0], ZOOM0);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>', maxZoom:19
}).addTo(mapa);

const icono = L.divIcon({
  html:'<div style="background:#dc3545;width:22px;height:22px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,.4);"></div>',
  iconSize:[22,22],iconAnchor:[11,22],popupAnchor:[0,-24]
});
let marcador = null;

function ponerMarcador(lat, lng, zoom) {
  if (marcador) { marcador.setLatLng([lat,lng]); } else {
    marcador = L.marker([lat,lng],{draggable:true,icon:icono}).addTo(mapa);
    marcador.on('dragend', e => {
      const p = e.target.getLatLng();
      latInput.value = p.lat.toFixed(7); lngInput.value = p.lng.toFixed(7);
      document.getElementById('gps-status').textContent = `ğŸ“ ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`;
    });
  }
  latInput.value = lat.toFixed(7); lngInput.value = lng.toFixed(7);
  if (zoom) mapa.setView([lat,lng],zoom);
  document.getElementById('gps-status').textContent = `ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

mapa.on('click', e => ponerMarcador(e.latlng.lat, e.latlng.lng, null));
if (latInput.value && lngInput.value) ponerMarcador(parseFloat(latInput.value), parseFloat(lngInput.value), 15);

function usarGPS() {
  const st = document.getElementById('gps-status');
  if (!navigator.geolocation) { st.textContent='âŒ GPS no disponible'; return; }
  st.textContent = 'â³ Obteniendo ubicaciÃ³n...';
  navigator.geolocation.getCurrentPosition(
    p => ponerMarcador(p.coords.latitude, p.coords.longitude, 16),
    () => { st.textContent='âŒ No se pudo. Haz clic en el mapa.'; }
  );
}

function buscarDir() {
  const dir  = document.querySelector('[name="direccion"]')?.value?.trim() || '';
  const barr = document.querySelector('[name="barrio"]')?.value?.trim()    || '';
  const mun  = selMun.options[selMun.selectedIndex]?.text || '';
  const q    = [dir,barr,mun,'Colombia'].filter(x => x && !x.startsWith('â€”')).join(', ');
  if (!dir) { alert('Escribe primero la direcciÃ³n del votante.'); return; }
  const st = document.getElementById('gps-status');
  st.textContent = 'â³ Buscandoâ€¦';
  fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`)
    .then(r => r.json()).then(data => {
      if (data.length) { ponerMarcador(parseFloat(data[0].lat), parseFloat(data[0].lon), 16); st.textContent = 'âœ… '+data[0].display_name.substring(0,60)+'â€¦'; }
      else st.textContent = 'âŒ No encontrado. Haz clic en el mapa.';
    });
}

setTimeout(() => mapa.invalidateSize(), 300);
</script>
{% endblock %}
