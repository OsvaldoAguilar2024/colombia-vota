{% extends 'votacion/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ titulo }} - Colombia Vota{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'votante_lista' %}" class="text-decoration-none">Votantes</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
#mapa-votante { z-index: 1; }
/* ocultar lat/lng del usuario â€” solo para uso interno */
#div_id_latitud, #div_id_longitud { display: none !important; }
.leaflet-popup-content { font-size: .9rem; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <h4 class="fw-bold mb-4">
          <i class="bi bi-person-plus text-primary me-2"></i>{{ titulo }}
        </h4>

        {% if from_encuestador %}
        <div class="alert alert-info d-flex align-items-center gap-2 mb-3">
          <i class="bi bi-info-circle-fill"></i>
          <span>El ciudadano no estÃ¡ registrado. Complete sus datos para continuar con la encuesta.</span>
        </div>
        {% endif %}

        <form method="post" id="votanteForm" enctype="multipart/form-data">
          {% csrf_token %}
          {% if from_encuestador %}<input type="hidden" name="from_encuestador" value="1">{% endif %}
          {% crispy form %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// â”€â”€ Cascada departamento â†’ municipio â†’ puesto â†’ mesa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cargarMunicipios(depId) {
  const sel = document.getElementById('id_municipio');
  sel.innerHTML = '<option value="">---------</option>';
  document.getElementById('id_puesto').innerHTML = '<option value="">---------</option>';
  document.getElementById('id_mesa').innerHTML   = '<option value="">---------</option>';
  if (!depId) return;
  fetch('/api/municipios/?departamento_id=' + depId)
    .then(r => r.json()).then(data => {
      data.forEach(m => { sel.innerHTML += `<option value="${m.id}">${m.nombre}</option>`; });
    });
}
function cargarPuestos(munId) {
  const sel = document.getElementById('id_puesto');
  sel.innerHTML = '<option value="">---------</option>';
  document.getElementById('id_mesa').innerHTML = '<option value="">---------</option>';
  if (!munId) return;
  fetch('/api/puestos/?municipio_id=' + munId)
    .then(r => r.json()).then(data => {
      data.forEach(p => { sel.innerHTML += `<option value="${p.id}">${p.nombre}</option>`; });
    });
}
function cargarMesas(puestoId) {
  const sel = document.getElementById('id_mesa');
  sel.innerHTML = '<option value="">---------</option>';
  if (!puestoId) return;
  fetch('/api/mesas/?puesto_id=' + puestoId)
    .then(r => r.json()).then(data => {
      data.forEach(m => { sel.innerHTML += `<option value="${m.id}">Mesa ${m.numero}</option>`; });
    });
}

// â”€â”€ Asegurar eventos aunque el widget no tenga onchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  const selDep = document.getElementById('id_departamento');
  const selMun = document.getElementById('id_municipio');
  const selPue = document.getElementById('id_puesto');

  if (selDep) selDep.addEventListener('change', e => cargarMunicipios(e.target.value));
  if (selMun) selMun.addEventListener('change', e => cargarPuestos(e.target.value));
  if (selPue) selPue.addEventListener('change', e => cargarMesas(e.target.value));

  // Al EDITAR: pre-cargar los selects dependientes con los valores guardados
  {% if form.instance.pk %}
  const munActual   = "{{ form.instance.municipio_id|default:'' }}";
  const puestoActual = "{{ form.instance.puesto_id|default:'' }}";
  const mesaActual   = "{{ form.instance.mesa_id|default:'' }}";

  if (selDep && selDep.value) {
    fetch('/api/municipios/?departamento_id=' + selDep.value)
      .then(r => r.json()).then(data => {
        selMun.innerHTML = '<option value="">---------</option>';
        data.forEach(m => {
          const sel = m.id == munActual ? ' selected' : '';
          selMun.innerHTML += `<option value="${m.id}"${sel}>${m.nombre}</option>`;
        });
        // Luego cargar puestos si hay municipio
        if (munActual) {
          fetch('/api/puestos/?municipio_id=' + munActual)
            .then(r => r.json()).then(data2 => {
              selPue.innerHTML = '<option value="">---------</option>';
              data2.forEach(p => {
                const sel = p.id == puestoActual ? ' selected' : '';
                selPue.innerHTML += `<option value="${p.id}"${sel}>${p.nombre}</option>`;
              });
              // Luego cargar mesas si hay puesto
              if (puestoActual) {
                fetch('/api/mesas/?puesto_id=' + puestoActual)
                  .then(r => r.json()).then(data3 => {
                    document.getElementById('id_mesa').innerHTML = '<option value="">---------</option>';
                    data3.forEach(m => {
                      const sel = m.id == mesaActual ? ' selected' : '';
                      document.getElementById('id_mesa').innerHTML += `<option value="${m.id}"${sel}>Mesa ${m.numero}</option>`;
                    });
                  });
              }
            });
        }
      });
  }
  {% endif %}
});

// â”€â”€ Mapa Leaflet (OpenStreetMap, sin API key) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LAT_INIT = {{ form.instance.latitud|default:"4.7110" }};
const LNG_INIT = {{ form.instance.longitud|default:"-74.0721" }};
const ZOOM_INIT = {% if form.instance.latitud %}15{% else %}6{% endif %};

const mapa = L.map('mapa-votante').setView([LAT_INIT, LNG_INIT], ZOOM_INIT);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19
}).addTo(mapa);

// Marcador arrastrable
const icono = L.divIcon({
  html: '<div style="background:#dc3545;width:22px;height:22px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,.4);"></div>',
  iconSize: [22, 22], iconAnchor: [11, 22], popupAnchor: [0, -24]
});

let marcador = null;
const latInput = document.getElementById('id_latitud');
const lngInput = document.getElementById('id_longitud');

function colocarMarcador(lat, lng, zoom) {
  const latlng = L.latLng(lat, lng);
  if (marcador) {
    marcador.setLatLng(latlng);
  } else {
    marcador = L.marker(latlng, { draggable: true, icon: icono }).addTo(mapa);
    marcador.on('dragend', e => actualizarCoordenadas(e.target.getLatLng().lat, e.target.getLatLng().lng));
  }
  latInput.value = lat.toFixed(7);
  lngInput.value = lng.toFixed(7);
  if (zoom) mapa.setView(latlng, zoom);
  document.getElementById('gps-status').textContent = `ðŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

function actualizarCoordenadas(lat, lng) {
  latInput.value = lat.toFixed(7);
  lngInput.value = lng.toFixed(7);
  document.getElementById('gps-status').textContent = `ðŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

// Clic en el mapa coloca el marcador
mapa.on('click', e => colocarMarcador(e.latlng.lat, e.latlng.lng, null));

// Si ya tenÃ­a coordenadas, mostrar marcador
{% if form.instance.latitud and form.instance.longitud %}
colocarMarcador({{ form.instance.latitud }}, {{ form.instance.longitud }}, 15);
{% endif %}

// BotÃ³n GPS: detectar ubicaciÃ³n actual
function usarMiUbicacion() {
  const st = document.getElementById('gps-status');
  if (!navigator.geolocation) { st.textContent = 'âŒ GPS no disponible en este dispositivo'; return; }
  st.textContent = 'â³ Obteniendo ubicaciÃ³n...';
  navigator.geolocation.getCurrentPosition(
    pos => colocarMarcador(pos.coords.latitude, pos.coords.longitude, 16),
    () => { st.textContent = 'âŒ No se pudo obtener la ubicaciÃ³n. Haz clic en el mapa.'; }
  );
}

// BotÃ³n buscar direcciÃ³n: usa la direcciÃ³n escrita para geocodificar con Nominatim
function buscarDireccion() {
  const dir   = document.getElementById('id_direccion')?.value?.trim() || '';
  const barr  = document.getElementById('id_barrio')?.value?.trim()    || '';
  const munEl = document.getElementById('id_municipio');
  const mun   = munEl?.options[munEl.selectedIndex]?.text || '';
  const query = [dir, barr, mun, 'Colombia'].filter(Boolean).join(', ');
  if (!dir) { alert('Escribe primero la direcciÃ³n del votante.'); return; }
  const st = document.getElementById('gps-status');
  st.textContent = 'â³ Buscando "' + query + '"â€¦';
  fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`)
    .then(r => r.json())
    .then(data => {
      if (data.length) {
        colocarMarcador(parseFloat(data[0].lat), parseFloat(data[0].lon), 16);
        st.textContent = 'âœ… ' + data[0].display_name.substring(0, 60) + 'â€¦';
      } else {
        st.textContent = 'âŒ No se encontrÃ³ la direcciÃ³n. Haz clic manual en el mapa.';
      }
    });
}

// Forzar redibujado del mapa al mostrar (previene tiles grises)
setTimeout(() => mapa.invalidateSize(), 300);
</script>
{% endblock %}
