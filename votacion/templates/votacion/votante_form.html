{% extends 'votacion/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ titulo }} - Colombia Vota{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'votante_lista' %}" class="text-decoration-none">Votantes</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
#mapa-votante { z-index: 1; }
#div_id_latitud, #div_id_longitud,
#div_id_municipio, #div_id_puesto, #div_id_mesa { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <h4 class="fw-bold mb-4">
          <i class="bi bi-person-plus text-primary me-2"></i>{{ titulo }}
        </h4>

        {% if from_encuestador %}
        <div class="alert alert-info d-flex align-items-center gap-2 mb-3">
          <i class="bi bi-info-circle-fill"></i>
          <span>El ciudadano no estÃ¡ registrado. Complete sus datos para continuar con la encuesta.</span>
        </div>
        {% endif %}

        <form method="post" id="votanteForm" enctype="multipart/form-data">
          {% csrf_token %}
          {% if from_encuestador %}<input type="hidden" name="from_encuestador" value="1">{% endif %}

          {% crispy form %}

          {# â”€â”€ Lugar de VotaciÃ³n â€” renderizado 100% manual para evitar duplicados â”€â”€ #}
          <div id="bloque_lugar_votacion" style="margin-top:-10px;">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Departamento</label>
                <select id="sel_departamento" class="form-select">
                  <option value="">---------</option>
                  {% for dep in departamentos %}
                  <option value="{{ dep.id }}"
                    {% if form.instance.departamento_id == dep.id %}selected{% endif %}>
                    {{ dep.nombre }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Ciudad / Municipio</label>
                <select id="sel_municipio" class="form-select">
                  <option value="">â€” Selecciona departamento primero â€”</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Puesto de VotaciÃ³n</label>
                <select id="sel_puesto" class="form-select">
                  <option value="">â€” Selecciona municipio primero â€”</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Mesa</label>
                <select id="sel_mesa" class="form-select">
                  <option value="">â€” Selecciona puesto primero â€”</option>
                </select>
              </div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASCADA: departamento â†’ municipio â†’ puesto â†’ mesa
// Los selects son completamente manuales (sin Django form)
// Los valores se envÃ­an como campos hidden al servidor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Valores actuales (para ediciÃ³n)
const INIT = {
  dep:    "{{ form.instance.departamento_id|default:'' }}",
  mun:    "{{ form.instance.municipio_id|default:'' }}",
  puesto: "{{ form.instance.puesto_id|default:'' }}",
  mesa:   "{{ form.instance.mesa_id|default:'' }}",
};

const selDep    = document.getElementById('sel_departamento');
const selMun    = document.getElementById('sel_municipio');
const selPuesto = document.getElementById('sel_puesto');
const selMesa   = document.getElementById('sel_mesa');

// Campos hidden que se envÃ­an al servidor
const hidMun    = document.getElementById('val_municipio');
const hidPuesto = document.getElementById('val_puesto');
const hidMesa   = document.getElementById('val_mesa');

function resetSelect(sel, placeholder) {
  sel.innerHTML = `<option value="">${placeholder}</option>`;
}

function cargarMunicipios(depId, seleccionarId) {
  resetSelect(selMun,    'â€” Selecciona municipio â€”');
  resetSelect(selPuesto, 'â€” Selecciona municipio primero â€”');
  resetSelect(selMesa,   'â€” Selecciona puesto primero â€”');
  hidMun.value = ''; hidPuesto.value = ''; hidMesa.value = '';
  if (!depId) return;

  fetch('/api/municipios/?departamento_id=' + depId)
    .then(r => r.json())
    .then(data => {
      data.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.nombre;
        if (String(m.id) === String(seleccionarId)) opt.selected = true;
        selMun.appendChild(opt);
      });
      if (seleccionarId) {
        hidMun.value = seleccionarId;
        cargarPuestos(seleccionarId, INIT.puesto);
      }
    });
}

function cargarPuestos(munId, seleccionarId) {
  resetSelect(selPuesto, 'â€” Selecciona puesto â€”');
  resetSelect(selMesa,   'â€” Selecciona puesto primero â€”');
  hidPuesto.value = ''; hidMesa.value = '';
  if (!munId) return;

  fetch('/api/puestos/?municipio_id=' + munId)
    .then(r => r.json())
    .then(data => {
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.nombre;
        if (String(p.id) === String(seleccionarId)) opt.selected = true;
        selPuesto.appendChild(opt);
      });
      if (seleccionarId) {
        hidPuesto.value = seleccionarId;
        cargarMesas(seleccionarId, INIT.mesa);
      }
    });
}

function cargarMesas(puestoId, seleccionarId) {
  resetSelect(selMesa, 'â€” Selecciona mesa â€”');
  hidMesa.value = '';
  if (!puestoId) return;

  fetch('/api/mesas/?puesto_id=' + puestoId)
    .then(r => r.json())
    .then(data => {
      data.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = 'Mesa ' + m.numero + (m.zona ? ' â€” ' + m.zona : '');
        if (String(m.id) === String(seleccionarId)) opt.selected = true;
        selMesa.appendChild(opt);
      });
      if (seleccionarId) hidMesa.value = seleccionarId;
    });
}

// Eventos de cambio
selDep.addEventListener('change', e => {
  INIT.mun = ''; INIT.puesto = ''; INIT.mesa = '';
  cargarMunicipios(e.target.value, '');
});
selMun.addEventListener('change', e => {
  hidMun.value = e.target.value;
  INIT.puesto = ''; INIT.mesa = '';
  cargarPuestos(e.target.value, '');
});
selPuesto.addEventListener('change', e => {
  hidPuesto.value = e.target.value;
  INIT.mesa = '';
  cargarMesas(e.target.value, '');
});
selMesa.addEventListener('change', e => {
  hidMesa.value = e.target.value;
});

// Al editar: pre-cargar en cascada
document.addEventListener('DOMContentLoaded', () => {
  if (INIT.dep) {
    cargarMunicipios(INIT.dep, INIT.mun);
    // El resto de la cadena se dispara desde dentro de cargarMunicipios
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPA LEAFLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LAT_INIT  = {{ form.instance.latitud|default:"4.7110" }};
const LNG_INIT  = {{ form.instance.longitud|default:"-74.0721" }};
const ZOOM_INIT = {% if form.instance.latitud %}15{% else %}6{% endif %};

const mapa = L.map('mapa-votante').setView([LAT_INIT, LNG_INIT], ZOOM_INIT);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19
}).addTo(mapa);

const icono = L.divIcon({
  html: '<div style="background:#dc3545;width:22px;height:22px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,.4);"></div>',
  iconSize: [22,22], iconAnchor: [11,22], popupAnchor: [0,-24]
});

let marcador = null;
const latInput = document.getElementById('id_latitud');
const lngInput = document.getElementById('id_longitud');

function colocarMarcador(lat, lng, zoom) {
  const latlng = L.latLng(lat, lng);
  if (marcador) {
    marcador.setLatLng(latlng);
  } else {
    marcador = L.marker(latlng, { draggable: true, icon: icono }).addTo(mapa);
    marcador.on('dragend', e => {
      latInput.value = e.target.getLatLng().lat.toFixed(7);
      lngInput.value = e.target.getLatLng().lng.toFixed(7);
      document.getElementById('gps-status').textContent = `ğŸ“ ${e.target.getLatLng().lat.toFixed(5)}, ${e.target.getLatLng().lng.toFixed(5)}`;
    });
  }
  latInput.value = lat.toFixed(7);
  lngInput.value = lng.toFixed(7);
  if (zoom) mapa.setView(latlng, zoom);
  document.getElementById('gps-status').textContent = `ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

mapa.on('click', e => colocarMarcador(e.latlng.lat, e.latlng.lng, null));

{% if form.instance.latitud and form.instance.longitud %}
colocarMarcador({{ form.instance.latitud }}, {{ form.instance.longitud }}, 15);
{% endif %}

function usarMiUbicacion() {
  const st = document.getElementById('gps-status');
  if (!navigator.geolocation) { st.textContent = 'âŒ GPS no disponible'; return; }
  st.textContent = 'â³ Obteniendo ubicaciÃ³n...';
  navigator.geolocation.getCurrentPosition(
    pos => colocarMarcador(pos.coords.latitude, pos.coords.longitude, 16),
    () => { st.textContent = 'âŒ No se pudo obtener. Haz clic en el mapa.'; }
  );
}

function buscarDireccion() {
  const dir  = document.getElementById('id_direccion')?.value?.trim() || '';
  const barr = document.getElementById('id_barrio')?.value?.trim()    || '';
  const mun  = selMun.options[selMun.selectedIndex]?.text || '';
  const q    = [dir, barr, mun, 'Colombia'].filter(Boolean).join(', ');
  if (!dir) { alert('Escribe primero la direcciÃ³n.'); return; }
  const st = document.getElementById('gps-status');
  st.textContent = 'â³ Buscandoâ€¦';
  fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`)
    .then(r => r.json())
    .then(data => {
      if (data.length) {
        colocarMarcador(parseFloat(data[0].lat), parseFloat(data[0].lon), 16);
        st.textContent = 'âœ… ' + data[0].display_name.substring(0, 60) + 'â€¦';
      } else {
        st.textContent = 'âŒ No encontrado. Haz clic en el mapa.';
      }
    });
}

setTimeout(() => mapa.invalidateSize(), 300);
</script>
{% endblock %}
